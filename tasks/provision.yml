---

- name: Preflight checks
  ansible.builtin.include_tasks: preflight.yml

- name: Create temporary Heat file
  ansible.builtin.tempfile:
    state: file
    suffix: temp
  register: temp_heat_file
  delegate_to: localhost
  run_once: true

- name: Provision stack
  block:

    - name: Create Heat template contents
      ansible.builtin.template:
        src: stack.yml.j2
        dest: "{{ temp_heat_file.path }}"
        mode: '0600'
      when: temp_heat_file.path is defined
      delegate_to: localhost
      run_once: true

    - name: Create or update stack
      openstack.cloud.stack:
        name: "{{ nodes[0].app_name | default('stack') }}"
        tag: "{{ nodes[0].app_name | replace(' ', '_') | default('stack') }}"
        state: present
        template: "{{ temp_heat_file.path }}"
        parameters:
          public_network_id: "{{ public_network_id }}"
        validate_certs: "{{ os_stack_validate_certs | default(true) | bool }}"
      register: deploy
      failed_when: false
      until: >-
        (not (deploy.failed | default(false)))
        or ((deploy.msg | default('')) is not search('504 Gateway Time-out'))
      retries: 5
      delay: 15
      when:
        - nodes is defined
        - nodes[0] is defined
        - temp_heat_file is defined
        - temp_heat_file.path is defined
      delegate_to: localhost
      run_once: true

    - name: Fail if stack create/update failed
      ansible.builtin.fail:
        msg: >-
          Failed to create/update OpenStack stack '{{ nodes[0].app_name | default('stack') }}'.
          Error: {{ deploy.msg | default(deploy) }}
      when:
        - deploy is defined
        - deploy.failed | default(false)

    - name: Wait for servers to come online
      ansible.builtin.wait_for:
        host: "{{ item.output_value.public_ip }}"
        port: "{{ item.output_value.ansible_port | default(ansible_port) }}"
        timeout: "{{ instance_wait_connection_timeout }}"
      loop: "{{ deploy.stack.outputs }}"
      when:
        - wait_for_connection
        - nodes is defined
        - deploy is defined
        - deploy.stack is defined
        - deploy.stack.outputs is defined
        - "'public_ip' in item.output_key"

    - name: Wait for Windows systems to be available for connection
      ansible.builtin.wait_for_connection:
      vars:
        ansible_port: 5986
        ansible_connection: winrm
        ansible_winrm_transport: credssp
        ansible_winrm_server_cert_validation: ignore
      delegate_to: "{{ item.output_value.public_ip }}"
      loop: "{{ deploy.stack.outputs }}"
      failed_when: false
      when:
        - wait_for_connection
        - nodes is defined
        - deploy is defined
        - deploy.stack is defined
        - deploy.stack.outputs is defined
        - "'public_ip' in item.output_key"
        - item.output_value.ansible_port is defined
        - item.output_value.ansible_port == 5986

  rescue:

    - name: Surface root cause
      ansible.builtin.debug:
        var: ansible_failed_result

    - name: Fail with actionable message
      ansible.builtin.fail:
        msg: >-
          Failed to create/update OpenStack stack '{{ (nodes[0].app_name | default('stack')) if (nodes is defined and nodes | length > 0) else 'stack' }}'.
          Preflight should have validated referenced networks/images/flavors/keypairs.
          Error: {{ (ansible_failed_result.msg | default(ansible_failed_result)) }}

  always:

    - name: Remove temp Heat file
      ansible.builtin.file:
        path: "{{ temp_heat_file.path }}"
        state: absent
      when:
        - temp_heat_file is defined
        - temp_heat_file.path is defined
      delegate_to: localhost
      run_once: true
